<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <title>物聯網控制開門</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
</head>
<body>
    <div class="header">
        <div class="connect">
            <!-- <marquee class="title" width="50%">請按播放鍵!!</marquee> -->
            <p class="title">暫無連接</p>
        </div>
    </div>
    <div class="main">
        <div class="door" id="door">
            <img src="./source/幹.png" alt="">
            <div class="state">

            </div>
        </div>
        <div class="door_state">
            <img id="photo" src="./source/close_door.jpg" alt="">
        </div>
    </div>

    <script>
        var hostname = "192.168.50.166"
        var port = "8080"

        var connected = false;
        var client = new Paho.MQTT.Client(hostname, Number(port),"");

        client.startTrace();

        var options = {
            invocationContext: { host: hostname, port:port, clientId: "" },
            timeout: 5,
            keepAliveInterval: 60,
            cleanSession: true,
            useSSL: false ,
            //reconnect: true,
            onSuccess: onConnect,
            onFailure: onFail,
            mqttVersion: 4
        };

        client.connect(options)

        client.onConnected = onConnected
        client.onMessageArrived = onMessageArrived
        client.onConnectionLost = onConnectionLost

        function onConnect(context) {
            // Once a connection has been made, make a subscription and send a message.
            var connectionString = context.invocationContext.host + ":" + context.invocationContext.port + context.invocationContext.path;
            document.querySelector(".title").innerHTML = "現在連接到的是:" + hostname
            connected = true;

        }

        function onFail(context) {
            connected = false;

        }

        function onConnected(reconnect, uri) {
            // Once a connection has been made, make a subscription and send a message.
            connected = true;

        }

        function onMessageArrived(message) {

        }

        function onConnectionLost(responseObject) {
            document.querySelector(".title").innerHTML = "暫無連接"
            connected = false;
        }


        function publish(topic , message){
            messgae = new Paho.MQTT.Message(message)
            message.destinationName = topic
            messgae.qos = 0 ;
            message.retain = false;
            client.send(messgae);
        }

        let state = document.querySelector(".state");

        let door = document.getElementById("door");
        let photo = document.getElementById("photo");
        door.addEventListener("mousedown", function(){
            state.classList.add("open")
            photo.src = "./source/open_door.jpg";
            publish("tcivs/box/door","1")
        })

        door.addEventListener("mouseup", function(){
            state.classList.remove("open");
            photo.src = "./source/close_door.jpg";
        })
        door.addEventListener("touchstart", function(){
            state.classList.add("open")
            photo.src = "./source/open_door.jpg";
            publish("tcivs/box/door","1")
        })

        door.addEventListener("touchend", function(){
            state.classList.remove("open");
            photo.src = "./source/close_door.jpg";
        })
    </script>
</body>
</html>
